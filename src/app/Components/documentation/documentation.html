<app-navbar></app-navbar>
<section class="doc-wrapper">
  <header class="doc-hero">
    <div class="doc-hero__icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="28" height="28"><path fill="currentColor" d="M3 6a3 3 0 013-3h7l5 5v11a3 3 0 01-3 3H6a3 3 0 01-3-3V6zm9-1v4h4"/></svg>
    </div>
    <div>
      <h1>Grafana AutoBuilder — User Guide</h1>
      <p class="lead">Turn a simple CSV into a production‑ready Grafana dashboard in minutes. Supports PostgreSQL datasources.</p>
    </div>
  </header>

  <nav class="quick-nav" aria-label="Quick navigation">
    <a href="#what-is" class="chip">Overview</a>
    <a href="#get-started" class="chip">Get Started</a>
    <a href="#datasources" class="chip">Datasources</a>
    <a href="#csv-schema" class="chip">CSV Schema</a>
    <a href="#postgresql-setup" class="chip">PostgreSQL</a>
    <a href="#query-formats" class="chip">Query Formats</a>
    <a href="#mock-data" class="chip">Mock Data</a>
    <a href="#tips" class="chip">Tips</a>
    <a href="#troubleshooting" class="chip">Troubleshooting</a>
  </nav>

  <h2 id="what-is">What is Grafana AutoBuilder?</h2>
  <p>
    Grafana AutoBuilder converts a lightweight CSV specification into a complete
    Grafana dashboard. Each row in the CSV describes a single panel (its title,
    query, visualization, units, thresholds, and size). Upload the CSV and
    AutoBuilder will create and arrange the panels automatically, returning a
    link to open the dashboard in Grafana.
    <strong>Currently, only PostgreSQL datasources are supported.</strong>
  </p>

  <h2 id="get-started">Get started in 3 steps</h2>
  <ol>
    <li>Go to the <strong>Upload</strong> page in the app.</li>
    <li>Drag & drop your <code>.csv</code> file (or browse to select it).</li>
    <li>
      Click <em>Generate Dashboard</em> and then open the provided Grafana link.
    </li>
  </ol>

  <h2 id="datasources">Supported Datasources</h2>
  <p>
    Grafana AutoBuilder currently supports <strong>PostgreSQL only</strong>.
    You can still use <em>multiple PostgreSQL datasources</em> in one dashboard by
    specifying the datasource <em>UID</em> per row in the CSV. If left blank, the
    backend uses the default datasource UID from configuration.
  </p>

  <div class="callout callout-info">
    <strong>Bring Your Own Postgres (BYODB):</strong>
    Your CSV queries must reference tables/columns that already exist in your PostgreSQL database. The app does not auto-create tables.
  </div>

  <h2 id="db-requirements">Database Requirements & Validation</h2>
  <ul>
    <li><strong>Tables/columns must exist:</strong> The SQL in your CSV must match your database schema.</li>
    <li><strong>How to create/adjust schema:</strong> Use pgAdmin, psql, migrations (Flyway/Liquibase), or provided seed SQL.</li>
    <li><strong>Datasource UID:</strong> Ensure the CSV <code>datasource</code> column contains the correct Grafana Postgres UID, or leave blank to use the default.</li>
    <li><strong>Time filtering:</strong> Use <code>$__timeFrom()</code> and <code>$__timeTo()</code> in WHERE clauses.</li>
  </ul>

  <h3 id="validation-workflow">Validation workflow (avoid "No data")</h3>
  <ol>
    <li>Before generating a dashboard, send your CSV to <code>POST /api/dashboard/validate</code> as multipart with the field <code>file</code>.</li>
    <li>Review per-row results. Fix any missing tables/columns or SQL errors.</li>
    <li>When all rows are OK, upload the same CSV to generate the dashboard.</li>
  </ol>

  <div class="code-block">
    <div class="code-block__header">
      <span>Validate CSV via API</span>
      <button class="copy-btn" (click)="copy(codeValidate.textContent || '', 'validate')" [class.copied]="copiedId==='validate'">{{ copiedId==='validate' ? 'Copied' : 'Copy' }}</button>
    </div>
    <pre class="code" #codeValidate>
curl -F "file=@C:\\path\\to\\your.csv" http://localhost:8080/api/dashboard/validate
    </pre>
  </div>

  <h2 id="csv-schema">CSV schema (one row = one panel)</h2>
  <p>
    Use the following headers exactly (case‑sensitive). Unused fields can be
    left blank.
  </p>
  <ul>
    <li><code>title</code> — Panel title.</li>
    <li>
      <code>datasource</code> — Grafana datasource <em>UID</em> (PostgreSQL). If
      blank, the app uses the default UID from the backend config.
    </li>
    <li>
      <code>query</code> — SQL for PostgreSQL.
    </li>
    <li>
      <code>visualization</code> — One of: <code>timeseries</code> (default),
      <code>stat</code>, <code>barchart</code>, <code>gauge</code>.
    </li>
    <li>
      <code>unit</code> — Grafana unit (examples: <code>percent</code>,
      <code>bytes</code>, <code>s</code>, <code>ms</code>, <code>short</code>).
    </li>
    <li>
      <code>thresholds</code> — Optional alert colors as
      <code>low|high</code> numeric values (e.g., <code>80|90</code>).
    </li>
    <li>
      <code>w</code> — Optional width in grid units (defaults to
      <code>12</code>, grid is 24‑columns).
    </li>
    <li>
      <code>h</code> — Optional height in grid units (defaults to
      <code>8</code>).
    </li>
  </ul>

  <p><strong>Notes</strong></p>
  <ul>
    <li>
      If <code>visualization</code> is blank or unknown, it becomes
      <code>timeseries</code>.
    </li>
    <li>
      <code>thresholds</code> adds green/yellow/red steps; use two numbers like
      <code>80|90</code>.
    </li>
    <li>
      Leave <code>w</code> / <code>h</code> blank to use sensible defaults;
      panels auto‑wrap across the 24‑column grid.
    </li>
    <li>
      <strong>Multiple PostgreSQL datasources:</strong> Each panel can target a
      different Postgres datasource by setting the UID in the CSV
      <code>datasource</code> column.
    </li>
  </ul>

  <h3 id="csv-example-postgresql">Sample CSV - PostgreSQL</h3>
  <div class="code-block">
    <div class="code-block__header">
      <span>CSV snippet</span>
      <button class="copy-btn" (click)="copy(codeCsv.textContent || '', 'csv')" [class.copied]="copiedId==='csv'">{{ copiedId==='csv' ? 'Copied' : 'Copy' }}</button>
    </div>
    <pre class="code" #codeCsv>
title,datasource,query,visualization,unit,thresholds,w,h
User Registrations,fev06aq8frhfka,"SELECT DATE_TRUNC('day', created_at) as time, COUNT(*) as value FROM users WHERE created_at >= $__timeFrom() AND created_at <= $__timeTo() GROUP BY DATE_TRUNC('day', created_at) ORDER BY time",timeseries,short,100|200,12,8
Active Users,fev06aq8frhfka,"SELECT DATE_TRUNC('hour', last_login) as time, COUNT(DISTINCT user_id) as value FROM user_sessions WHERE last_login >= $__timeFrom() AND last_login <= $__timeTo() GROUP BY DATE_TRUNC('hour', last_login) ORDER BY time",timeseries,short,50|100,6,6
Error Rate,fev06aq8frhfka,"SELECT DATE_TRUNC('minute', timestamp) as time, (COUNT(CASE WHEN status_code >= 400 THEN 1 END) * 100.0 / COUNT(*)) as value FROM application_logs WHERE timestamp >= $__timeFrom() AND timestamp <= $__timeTo() GROUP BY DATE_TRUNC('minute', timestamp) ORDER BY time",barchart,percent,5|10,6,6
Response Time,fev06aq8frhfka,"SELECT DATE_TRUNC('minute', request_time) as time, AVG(response_time_ms) as value FROM api_requests WHERE request_time >= $__timeFrom() AND request_time <= $__timeTo() GROUP BY DATE_TRUNC('minute', request_time) ORDER BY time",timeseries,ms,200|500,12,6
    </pre>
  </div>
  >

  <h2 id="postgresql-setup">PostgreSQL Setup</h2>
  <p>To use PostgreSQL as a datasource, you need to:</p>
  <ol>
    <li>
      <strong>Add PostgreSQL datasource in Grafana:</strong>
      <ul>
        <li>Go to Grafana → Configuration → Data Sources</li>
        <li>Click "Add data source"</li>
        <li>Select "PostgreSQL"</li>
        <li>Configure connection details</li>
        <li>Copy the UID (e.g., <code>fev06aq8frhfka</code>) and use it in the CSV when overriding the default</li>
      </ul>
    </li>
    <li>
      <strong>Use the correct query format:</strong>
      <ul>
        <li>Must have <code>time</code> column (timestamp)</li>
        <li>Must have <code>value</code> column (numeric)</li>
        <li>
          Use <code>$__timeFrom()</code> and <code>$__timeTo()</code> for time
          filtering
        </li>
      </ul>
    </li>
    <li>
      <strong>Run the test data script:</strong>
      <div class="code-block">
        <div class="code-block__header">
          <span>psql command</span>
          <button class="copy-btn" (click)="copy(codePsql.textContent || '', 'psql')" [class.copied]="copiedId==='psql'">{{ copiedId==='psql' ? 'Copied' : 'Copy' }}</button>
        </div>
        <pre class="code" #codePsql>
psql -U grafana_user -d grafana_autobuilder -f src/Backend/setup_test_data.sql
        </pre>
      </div>
    </li>
  </ol>

  <h2 id="query-formats">Query Formats</h2>

  <h3>PostgreSQL (SQL)</h3>
  <div class="code-block">
    <div class="code-block__header">
      <span>PostgreSQL query examples</span>
      <button class="copy-btn" (click)="copy(codeSql.textContent || '', 'sql')" [class.copied]="copiedId==='sql'">{{ copiedId==='sql' ? 'Copied' : 'Copy' }}</button>
    </div>
    <pre class="code" #codeSql>
-- User registrations by day
SELECT 
  DATE_TRUNC('day', created_at) as time,
  COUNT(*) as value
FROM users 
WHERE created_at >= $__timeFrom() AND created_at <= $__timeTo()
GROUP BY DATE_TRUNC('day', created_at)
ORDER BY time

-- Error rate by minute
SELECT 
  DATE_TRUNC('minute', timestamp) as time,
  (COUNT(CASE WHEN status_code >= 400 THEN 1 END) * 100.0 / COUNT(*)) as value
FROM application_logs 
WHERE timestamp >= $__timeFrom() AND timestamp <= $__timeTo()
GROUP BY DATE_TRUNC('minute', timestamp)
ORDER BY time
    </pre>
  </div>
  >

  <h2 id="mock-data">Generate mock data</h2>
  <p>
    You can quickly produce a CSV of panel definitions for demos, testing, or
    kick‑starting a dashboard.
  </p>
  <ol>
    <li>
      <strong>With AI (recommended):</strong> copy the prompt below into your
      favorite AI tool.
    </li>
    <li>
      <strong>Manual:</strong> duplicate the sample CSV above and change
      titles/queries/units as needed.
    </li>
  </ol>

  <h3 id="ai-prompt">AI prompt to generate a CSV for this project</h3>
  <div class="code-block">
    <div class="code-block__header">
      <span>AI prompt</span>
      <button class="copy-btn" (click)="copy(codeAi.textContent || '', 'ai')" [class.copied]="copiedId==='ai'">{{ copiedId==='ai' ? 'Copied' : 'Copy' }}</button>
    </div>
    <pre class="code" #codeAi>
You are generating a CSV for Grafana AutoBuilder. Output ONLY valid CSV with this header:
title,datasource,query,visualization,unit,thresholds,w,h

Requirements:
- PostgreSQL datasource only
- Use SQL queries with $__timeFrom() and $__timeTo() time variables
- Provide 6–10 panels covering timeseries, stat, barchart, and gauge
- Use units like percent, bytes, s, ms, short when appropriate
- Use thresholds in the form low|high (e.g., 80|90) when useful
- Use widths/heights that fit a 24-column grid (e.g., w=12,h=8 for large charts; w=6,h=6 for small)

PostgreSQL query requirements:
- Must have "time" column (timestamp) and "value" column (numeric)
- Use DATE_TRUNC() for time grouping
- Include WHERE clause with $__timeFrom() and $__timeTo()
- ORDER BY time

Return ONLY the CSV rows including the header. No commentary.
    </pre>
  </div>
  >

  <h2 id="tips">Tips & validation</h2>
  <ul class="tips-list">
    <li>Header names must match the schema. Extra columns are ignored.</li>
    <li>
      Leave cells empty rather than writing <code>n/a</code> to avoid parsing
      issues.
    </li>
    <li>
      If a panel doesn't render, check the <code>datasource</code> UID and the
      <code>query</code> syntax.
    </li>
    <li>
      <strong>PostgreSQL queries:</strong> Always use
      <code>$__timeFrom()</code> and <code>$__timeTo()</code>
      for time filtering to avoid "no data" issues.
    </li>
    <li>
      <strong>Multiple PostgreSQL datasources:</strong> Each panel can use a
      different Postgres datasource by setting the UID in the CSV.
    </li>
    <li>
      After upload, the app shows the dashboard title and a link to open it in
      Grafana.
    </li>
    <li>
      <strong>Time range:</strong> Dashboards are created with a default 7-day
      time range to ensure data is visible immediately.
    </li>
  </ul>

  <h2 id="troubleshooting">Troubleshooting</h2>
  <ul class="tips-list">
    <li>
      <strong>No data showing:</strong> Check that your PostgreSQL queries use
      <code>$__timeFrom()</code> and <code>$__timeTo()</code>
    </li>
    <li>
      <strong>PostgreSQL connection issues:</strong> Verify datasource
      configuration in Grafana
    </li>
    <li>
      <strong>Query errors:</strong> Test queries directly in Grafana's query
      editor first
    </li>
    <li>
      <strong>Time range issues:</strong> The dashboard defaults to "last 7
      days" - adjust in Grafana if needed
    </li>
  </ul>
</section>
