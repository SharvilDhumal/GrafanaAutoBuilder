<app-navbar></app-navbar>
<section class="doc-wrapper">
  <header class="doc-hero">
    <div class="doc-hero__icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="28" height="28"><path fill="currentColor" d="M3 6a3 3 0 013-3h7l5 5v11a3 3 0 01-3 3H6a3 3 0 01-3-3V6zm9-1v4h4"/></svg>
    </div>
    <div>
      <h1>Grafana AutoBuilder ‚Äî User Guide</h1>
      <p class="lead">Turn a simple CSV into a production‚Äëready Grafana dashboard in minutes. Supports PostgreSQL datasources.</p>
    </div>
  </header>

  <!-- Top tabs removed; right-hand TOC already provides navigation. -->

  <div class="doc-grid">
    <main class="doc-main">

  <h2 id="what-is">üìò What is Grafana AutoBuilder?</h2>
  <p>
    Grafana AutoBuilder converts a lightweight CSV specification into a complete
    Grafana dashboard. Each row in the CSV describes a single panel (its title,
    query, visualization, units, thresholds, and size). Upload the CSV and
    AutoBuilder will create and arrange the panels automatically, returning a
    link to open the dashboard in Grafana.
    <strong>Currently, only PostgreSQL datasources are supported.</strong>
  </p>

  <h2 id="get-started">‚ö° Get started in 3 steps</h2>
  <div class="callout callout-info">
    <strong>First time here?</strong> Please <a routerLink="/login">log in</a> before generating a dashboard.
  </div>
  <div class="steps">
    <div class="step-card">
      <div class="step-num">1</div>
      <div class="step-body">Go to the <strong>Upload</strong> page in the app.</div>
    </div>
    <div class="step-card">
      <div class="step-num">2</div>
      <div class="step-body">Drag & drop your <code>.csv</code> file (or browse to select it).</div>
    </div>
    <div class="step-card">
      <div class="step-num">3</div>
      <div class="step-body">Click <strong>Generate Dashboard</strong> and then open the provided Grafana link.</div>
    </div>
  </div>
  <a class="btn-primary" routerLink="/login">Login to Generate Dashboard</a>

  <h2 id="datasources">üóÑÔ∏è Supported Datasources</h2>
  <p>
    Grafana AutoBuilder currently supports <strong>PostgreSQL only</strong>.
    You can still use <em>multiple PostgreSQL datasources</em> in one dashboard by
    specifying the datasource <em>UID</em> per row in the CSV. If left blank, the
    backend uses the default datasource UID from configuration.
  </p>

  <div class="callout callout-info">
    <strong>Bring Your Own Postgres (BYODB):</strong>
    Your CSV queries must reference tables/columns that already exist in your PostgreSQL database. The app does not auto-create tables.
  </div>

  <h2 id="db-requirements">Database Requirements & Validation</h2>
  <ul>
    <li><strong>Tables/columns must exist:</strong> The SQL in your CSV must match your database schema.</li>
    <li><strong>How to create/adjust schema:</strong> Use pgAdmin, psql, migrations (Flyway/Liquibase), or provided seed SQL.</li>
    <li><strong>Datasource UID:</strong> Ensure the CSV <code>datasource</code> column contains the correct Grafana Postgres UID, or leave blank to use the default.</li>
    <li><strong>Time filtering:</strong> Use <code>$__timeFrom()</code> and <code>$__timeTo()</code> in WHERE clauses.</li>
  </ul>

  <h3 id="validation-workflow">Validation workflow (avoid "No data")</h3>
  <ol>
    <li>Before generating a dashboard, send your CSV to <code>POST /api/dashboard/validate</code> as multipart with the field <code>file</code>.</li>
    <li>Review per-row results. Fix any missing tables/columns or SQL errors.</li>
    <li>When all rows are OK, upload the same CSV to generate the dashboard.</li>
  </ol>

  <div class="code-block">
    <div class="code-block__header">
      <span>Validate CSV via API</span>
      <button class="copy-btn" (click)="copy(codeValidate.textContent || '', 'validate')" [class.copied]="copiedId==='validate'">{{ copiedId==='validate' ? 'Copied' : 'Copy' }}</button>
    </div>
    <pre class="code" #codeValidate>
curl -F "file=@C:\\path\\to\\your.csv" http://localhost:8080/api/dashboard/validate
    </pre>
  </div>

  <h2 id="csv-schema">üßæ CSV schema (one row = one panel)</h2>
  <p>
    Use the following headers exactly (case‚Äësensitive). Optional fields can be
    left blank or omitted entirely from the CSV header.
  </p>
  <ul>
    <li><code>title</code> ‚Äî Panel title.</li>
    <li>
      <code>datasource</code> ‚Äî Grafana datasource <em>UID</em> (PostgreSQL). If
      blank, the app uses the default UID from the backend config.
    </li>
    <li>
      <code>query</code> ‚Äî SQL for PostgreSQL.
    </li>
    <li>
      <code>visualization</code> ‚Äî One of: <code>timeseries</code> (default),
      <code>stat</code>, <code>barchart</code>, <code>gauge</code>.
      <br/>
      <strong>Aliases:</strong> You may also use <code>panel_type</code>, <code>chart_type</code>, or <code>viewType</code> instead of <code>visualization</code>.
    </li>
    <li>
      <code>unit</code> ‚Äî Grafana unit (examples: <code>percent</code>,
      <code>bytes</code>, <code>s</code>, <code>ms</code>, <code>short</code>).
    </li>
    <li>
      <code>thresholds</code> ‚Äî Optional alert colors as
      <code>low|high</code> numeric values (e.g., <code>80|90</code>). May be omitted.
    </li>
    <li>
      <code>w</code> ‚Äî Optional width in grid units (defaults to
      <code>12</code>, grid is 24‚Äëcolumns). May be omitted.
    </li>
    <li>
      <code>h</code> ‚Äî Optional height in grid units (defaults to
      <code>8</code>). May be omitted.
    </li>
  </ul>

  <p><strong>Notes</strong></p>
  <ul>
    <li>
      If <code>visualization</code> is blank or unknown, it becomes
      <code>timeseries</code>.
    </li>
    <li>
      <code>thresholds</code> adds green/yellow/red steps; use two numbers like
      <code>80|90</code>.
    </li>
    <li>
      Leave <code>w</code> / <code>h</code> blank to use sensible defaults;
      panels auto‚Äëwrap across the 24‚Äëcolumn grid.
    </li>
    <li>
      <strong>Multiple PostgreSQL datasources:</strong> Each panel can target a
      different Postgres datasource by setting the UID in the CSV
      <code>datasource</code> column.
    </li>
  </ul>

  <h3 id="csv-example-postgresql">Sample CSV - PostgreSQL</h3>
  <div class="code-block">
    <div class="code-block__header">
      <span>CSV snippet</span>
      <button class="copy-btn" (click)="copy(codeCsv.textContent || '', 'csv')" [class.copied]="copiedId==='csv'">{{ copiedId==='csv' ? 'Copied' : 'Copy' }}</button>
    </div>
    <pre class="code" #codeCsv>
title,datasource,query,visualization,unit
User Registrations,fev06aq8frhfka,"SELECT DATE_TRUNC('day', created_at) as time, COUNT(*) as value FROM users WHERE created_at >= $__timeFrom() AND created_at <= $__timeTo() GROUP BY DATE_TRUNC('day', created_at) ORDER BY time",timeseries,short
Active Users,fev06aq8frhfka,"SELECT DATE_TRUNC('hour', last_login) as time, COUNT(DISTINCT user_id) as value FROM user_sessions WHERE last_login >= $__timeFrom() AND last_login <= $__timeTo() GROUP BY DATE_TRUNC('hour', last_login) ORDER BY time",timeseries,short
Error Rate,fev06aq8frhfka,"SELECT DATE_TRUNC('minute', timestamp) as time, (COUNT(CASE WHEN status_code >= 400 THEN 1 END) * 100.0 / COUNT(*)) as value FROM application_logs WHERE timestamp >= $__timeFrom() AND timestamp <= $__timeTo() GROUP BY DATE_TRUNC('minute', timestamp) ORDER BY time",barchart,percent
Response Time,fev06aq8frhfka,"SELECT DATE_TRUNC('minute', request_time) as time, AVG(response_time_ms) as value FROM api_requests WHERE request_time >= $__timeFrom() AND request_time <= $__timeTo() GROUP BY DATE_TRUNC('minute', request_time) ORDER BY time",timeseries,ms
    </pre>
  </div>
  >

  <h2 id="postgresql-setup">üêò PostgreSQL Setup</h2>
  <p>To use PostgreSQL as a datasource, you need to:</p>
  <ol>
    <li>
      <strong>Add PostgreSQL datasource in Grafana:</strong>
      <ul>
        <li>Go to Grafana ‚Üí Configuration ‚Üí Data Sources</li>
        <li>Click "Add data source"</li>
        <li>Select "PostgreSQL"</li>
        <li>Configure connection details</li>
        <li>Copy the UID (e.g., <code>fev06aq8frhfka</code>) and use it in the CSV when overriding the default</li>
      </ul>
    </li>
    <li>
      <strong>Use the correct query format:</strong>
      <ul>
        <li>Must have <code>time</code> column (timestamp)</li>
        <li>Must have <code>value</code> column (numeric)</li>
        <li>
          Use <code>$__timeFrom()</code> and <code>$__timeTo()</code> for time
          filtering
        </li>
      </ul>
    </li>
    <li>
      <strong>Run the test data script:</strong>
      <div class="code-block">
        <div class="code-block__header">
          <span>psql command</span>
          <button class="copy-btn" (click)="copy(codePsql.textContent || '', 'psql')" [class.copied]="copiedId==='psql'">{{ copiedId==='psql' ? 'Copied' : 'Copy' }}</button>
        </div>
        <pre class="code" #codePsql>
psql -U grafana_user -d grafana_autobuilder -f src/Backend/setup_test_data.sql
        </pre>
      </div>
    </li>
  </ol>

  <h2 id="query-formats">üîé Query Formats</h2>

  <h3>PostgreSQL (SQL)</h3>
  <div class="code-block">
    <div class="code-block__header">
      <span>PostgreSQL query examples</span>
      <button class="copy-btn" (click)="copy(codeSql.textContent || '', 'sql')" [class.copied]="copiedId==='sql'">{{ copiedId==='sql' ? 'Copied' : 'Copy' }}</button>
    </div>
    <pre class="code" #codeSql>
-- User registrations by day
SELECT 
  DATE_TRUNC('day', created_at) as time,
  COUNT(*) as value
FROM users 
WHERE created_at >= $__timeFrom() AND created_at <= $__timeTo()
GROUP BY DATE_TRUNC('day', created_at)
ORDER BY time

-- Error rate by minute
SELECT 
  DATE_TRUNC('minute', timestamp) as time,
  (COUNT(CASE WHEN status_code >= 400 THEN 1 END) * 100.0 / COUNT(*)) as value
FROM application_logs 
WHERE timestamp >= $__timeFrom() AND timestamp <= $__timeTo()
GROUP BY DATE_TRUNC('minute', timestamp)
ORDER BY time
    </pre>
  </div>
  >

  <h2 id="mock-data">üß™ Generate mock data</h2>
  <p>
    You can quickly produce a CSV of panel definitions for demos, testing, or
    kick‚Äëstarting a dashboard.
  </p>
  <ol>
    <li>
      <strong>With AI (recommended):</strong> copy the prompt below into your
      favorite AI tool.
    </li>
    <li>
      <strong>Manual:</strong> duplicate the sample CSV above and change
      titles/queries/units as needed.
    </li>
  </ol>

  <h3 id="ai-prompt">AI prompt to generate a CSV for this project</h3>
  <div class="code-block">
    <div class="code-block__header">
      <span>AI prompt</span>
      <button class="copy-btn" (click)="copy(codeAi.textContent || '', 'ai')" [class.copied]="copiedId==='ai'">{{ copiedId==='ai' ? 'Copied' : 'Copy' }}</button>
    </div>
    <pre class="code" #codeAi>
You are generating a CSV for Grafana AutoBuilder. Output ONLY valid CSV with this header:
title,datasource,query,visualization,unit

Requirements:
- PostgreSQL datasource only
- Use SQL queries with $__timeFrom() and $__timeTo() time variables
- Provide 6‚Äì10 panels covering timeseries, stat, barchart, and gauge
- Use units like percent, bytes, s, ms, short when appropriate

 Notes:
 - You may use aliases for visualization: panel_type, chart_type, or viewType (they map to visualization).

PostgreSQL query requirements:
- Must have "time" column (timestamp) and "value" column (numeric)
- Use DATE_TRUNC() for time grouping
- Include WHERE clause with $__timeFrom() and $__timeTo()
- ORDER BY time

Return ONLY the CSV rows including the header. No commentary.
    </pre>
  </div>
  >

  <h2 id="tips">üí° Tips & validation</h2>
  <ul class="tips-list">
    <li>Header names must match the schema. Extra columns are ignored.</li>
    <li>
      Leave cells empty rather than writing <code>n/a</code> to avoid parsing
      issues.
    </li>
    <li>
      If a panel doesn't render, check the <code>datasource</code> UID and the
      <code>query</code> syntax.
    </li>
    <li>
      <strong>PostgreSQL queries:</strong> Always use
      <code>$__timeFrom()</code> and <code>$__timeTo()</code>
      for time filtering to avoid "no data" issues.
    </li>
    <li>
      <strong>Multiple PostgreSQL datasources:</strong> Each panel can use a
      different Postgres datasource by setting the UID in the CSV.
    </li>
    <li>
      After upload, the app shows the dashboard title and a link to open it in
      Grafana.
    </li>
    <li>
      <strong>Time range:</strong> Dashboards are created with a default 7-day
      time range to ensure data is visible immediately.
    </li>
  </ul>

  <h2 id="troubleshooting">üõ†Ô∏è Troubleshooting</h2>
  <ul class="tips-list">
    <li>
      <strong>No data showing:</strong> Check that your PostgreSQL queries use
      <code>$__timeFrom()</code> and <code>$__timeTo()</code>
    </li>
    <li>
      <strong>PostgreSQL connection issues:</strong> Verify datasource
      configuration in Grafana
    </li>
    <li>
      <strong>Query errors:</strong> Test queries directly in Grafana's query
      editor first
    </li>
    <li>
      <strong>Time range issues:</strong> The dashboard defaults to "last 7
      days" - adjust in Grafana if needed
    </li>
  </ul>
    </main>

    <aside class="doc-aside">
      <div class="toc">
        <div class="toc-title">On this page</div>
        <a href="#what-is" [class.active]="activeId==='what-is'">Overview</a>
        <a href="#get-started" [class.active]="activeId==='get-started'">Get Started</a>
        <a href="#datasources" [class.active]="activeId==='datasources'">Datasources</a>
        <a href="#csv-schema" [class.active]="activeId==='csv-schema'">CSV Schema</a>
        <a href="#postgresql-setup" [class.active]="activeId==='postgresql-setup'">PostgreSQL</a>
        <a href="#query-formats" [class.active]="activeId==='query-formats'">Query Formats</a>
        <a href="#mock-data" [class.active]="activeId==='mock-data'">Mock Data</a>
        <a href="#tips" [class.active]="activeId==='tips'">Tips</a>
        <a href="#troubleshooting" [class.active]="activeId==='troubleshooting'">Troubleshooting</a>
      </div>

      <div class="info-card">
        <div class="info-title">Need a CSV?</div>
        <p class="highlight-white">Use the AI prompt below to generate a CSV tailored for AutoBuilder.</p>
        <a class="btn-secondary" href="#ai-prompt">View AI prompt</a>
      </div>
    </aside>
  </div>
</section>
<app-footer></app-footer>
